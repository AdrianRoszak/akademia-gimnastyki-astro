---
import { Image } from 'astro:assets';
import { getActivitiesNav } from '../../data/get-activities-nav';
import type { GlobalData } from '../../data/types';
import { urlForImage } from '../../utils';
import Container from '../atoms/Container.astro';
import MailIcon from '../atoms/icons/MailIcon.astro';
import Phone from '../atoms/icons/Phone.astro';

interface Props {
	data: GlobalData;
}

const { data } = Astro.props;
const activities = await getActivitiesNav();
---

<header class="weirdo-header">
  <Container>
    <nav class="wrapper">
      {data.companyLogo && (
        <a href='/' data-weirdo-nav="link" aria-label="Wróc na stronę główną" data-weirdo-nav-target-id="home">
          <div class="weirdo-logo">
            <Image
              src={urlForImage(data.companyLogo.source)
                .width(100)
                .format('webp')
                .quality(100)
                .url()
              }
              alt={data.companyName}
              width={100}
              height={100}
              class="logo"
            />
          </div>
        </a>
      )}
      <div class="links-wrapper">
        <a href='/o-nas'>
          O nas
        </a>
        <div class="dropdown" data-dropdown="activities">
          <button class="dropdown-trigger" aria-expanded="false" aria-haspopup="true">
            Dyscypliny
            <span class="dropdown-arrow">▼</span>
          </button>
                        <div class="dropdown-menu">
                {activities.map((activity) => (
                  <a href={`/dyscypliny/${activity.slug}`}>{activity.name}</a>
                ))}
              </div>
        </div>
        <a href="/obozy">
          Obozy
        </a>
        <a href='/polkolonie'>
          Półkolonie
        </a>
        <a href='/' data-weirdo-nav="link" data-weirdo-nav-target-id="events">
          Wydarzenia
        </a>
        <a href='/urodziny'>
          Urodziny
        </a>
        <a href="/faq">
          FAQ
        </a>
        <a href='https://naszestroje.pl/156-akademia-gimnastyki' target='_blank' rel='noopener noreferrer' aria-label='Sklep z naszymi strojami'>
          Sklep
        </a>
      </div>
      <div class="icons-wrapper">
        <a href={`tel:${data.companyPhone}`} aria-label="Zadzwoń do nas" class="icon-link">
          <Phone size={28} color="var(--weirdo-color-white" />
        </a>
        <a href={`mailto:${data.companyEmail}`} aria-label="Napisz do nas" class="icon-link">
          <MailIcon size={28} color="var(--weirdo-color-white" />
        </a>
        <button data-weirdo-nav-burger aria-label="Otwórz nawigację" class:list={["icon-link", 'burger-wrapper']}>
            <div class="bar"></div>
        </button>
      </div>
    </nav>
  </Container>
  <div class="mobile-nav-wrapper" data-weirdo="mobile-nav">
    <nav class="mobile-nav" >
      <a href='/o-nas' >
        O nas
      </a>
      <div class="mobile-dropdown" data-mobile-dropdown="activities">
        <button class="mobile-dropdown-trigger" aria-expanded="false">
          Dyscypliny
          <span class="mobile-dropdown-arrow">▼</span>
        </button>
        <div class="mobile-dropdown-menu">
          {activities.map(activity => (
            <a href={`/dyscypliny/${activity.slug}`}>
              {activity.name}
            </a>
          ))}
        </div>
      </div>
      <a href="/obozy">
          Obozy
        </a>
        <a href='/polkolonie'>
          Półkolonie
        </a>
      <a href='/' data-weirdo-nav="link" data-weirdo-nav-target-id="events">
        Wydarzenia
      </a>
      <a href='/urodziny'>
          Urodziny
        </a>
      <a href="/faq">FAQ</a>
      <a href='https://naszestroje.pl/156-akademia-gimnastyki' target='_blank' rel='noopener noreferrer' aria-label='Sklep z naszymi strojami'>
        Sklep
      </a>
    </nav>
  </div>
</header>

<script>
  window.addEventListener('load', () => {
    const navLinks = document.querySelectorAll('[data-weirdo-nav="link"]')
    const targets = document.querySelectorAll('[data-weirdo-nav-target]')
    const burgerButton = document.querySelector('[data-weirdo-nav-burger]')
    const mobileNav = document.querySelector('[data-weirdo="mobile-nav"]')
    const isHomePage = window.location.pathname === '/'

    // Desktop dropdown functionality
    const desktopDropdowns = document.querySelectorAll('[data-dropdown]')
    desktopDropdowns.forEach(dropdown => {
      const trigger = dropdown.querySelector('.dropdown-trigger')
      const menu = dropdown.querySelector('.dropdown-menu')
      
      if (trigger && menu) {
        trigger.addEventListener('click', (e) => {
          e.preventDefault()
          const isOpen = trigger.getAttribute('aria-expanded') === 'true'
          
          // Close all other dropdowns
          desktopDropdowns.forEach(otherDropdown => {
            if (otherDropdown !== dropdown) {
              const otherTrigger = otherDropdown.querySelector('.dropdown-trigger')
              const otherMenu = otherDropdown.querySelector('.dropdown-menu')
              if (otherTrigger && otherMenu) {
                otherTrigger.setAttribute('aria-expanded', 'false')
                otherMenu.classList.remove('open')
              }
            }
          })
          
          // Toggle current dropdown
          trigger.setAttribute('aria-expanded', !isOpen ? 'true' : 'false')
          menu.classList.toggle('open', !isOpen)
        })
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!dropdown.contains(e.target as Node)) {
            trigger.setAttribute('aria-expanded', 'false')
            menu.classList.remove('open')
          }
        })
      }
    })

    // Mobile dropdown functionality
    const mobileDropdowns = document.querySelectorAll('[data-mobile-dropdown]')
    mobileDropdowns.forEach(dropdown => {
      const trigger = dropdown.querySelector('.mobile-dropdown-trigger')
      const menu = dropdown.querySelector('.mobile-dropdown-menu')
      
      if (trigger && menu) {
        trigger.addEventListener('click', (e) => {
          e.preventDefault()
          e.stopPropagation() // Prevent event from bubbling up and closing mobile nav
          const isOpen = trigger.getAttribute('aria-expanded') === 'true'
          trigger.setAttribute('aria-expanded', !isOpen ? 'true' : 'false')
          menu.classList.toggle('open', !isOpen)
        })
      }
    })

    navLinks.forEach(link => {
      const targetId = link.getAttribute('data-weirdo-nav-target-id')

      link.addEventListener('click', (e) => {
        e.preventDefault()
        if (!isHomePage) {
          window.location.href = `/#${targetId}`
        }
        
        if (targets) {
          targets.forEach(target => {
            const id = target.getAttribute('data-weirdo-nav-target')
            const offset = target.getBoundingClientRect().top + window.scrollY - 50
            if (id === targetId) {
              window.scrollTo({
                top: offset,
                behavior: 'smooth'
              })
            }
          })
        } else {
          console.error('No targets found')
        }
      })
    })

    if (burgerButton && mobileNav) {
      burgerButton.addEventListener('click', () => {
        if (document.documentElement.style.overflow === 'hidden') {
          document.documentElement.style.overflow = 'auto'
        } else {
          document.documentElement.style.overflow = 'hidden'
        }
        mobileNav.classList.toggle('open')
        burgerButton.classList.toggle('active')
      })

      mobileNav.addEventListener('click', () => {
        document.documentElement.style.overflow = 'auto'

        window.setTimeout(() => {
          mobileNav.classList.remove('open')
          burgerButton.classList.remove('active')
        }, 400)
      })
    }
  })
</script>

<style>
  .wrapper {
    margin: 0 auto;
    box-shadow: var(--weirdo-shadow-default);
    background: var(--weirdo-color-white);
    padding: 0.5rem;
    background: #fafafa;
    display: flex;
    align-items: center;
    gap: 2rem;
    justify-content: space-between;

    @media (min-width: 1024px) {
      width: 90%;
      justify-content: flex-start;
    }

    @media (min-width:1200px) {
      width: 80%;
      padding: 1rem;
    }

    .links-wrapper {
      display: none;
      flex-grow: 1;
      align-items: center;
      gap: 1rem;

      @media (min-width: 1024px) {
        display: flex;
      }

      @media (min-width: 1180px) {
        padding-left: 2rem;
      }
      
      @media (min-width: 1200px) {
        gap: 2rem;
      }

      a {
        text-wrap: nowrap;

        &:hover {
          color: var(--weirdo-color-accent-2);
        }
      }
    }

    /* Desktop Dropdown Styles */
    .dropdown {
      position: relative;
      display: inline-block;

      .dropdown-trigger {
        background: none;
        border: none;
        font-family: inherit;
        font-size: inherit;
        color: inherit;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-wrap: nowrap;

        &:hover {
          color: var(--weirdo-color-accent-2);
        }

        .dropdown-arrow {
          font-size: 0.8em;
          transition: transform 0.2s ease;
        }

        &[aria-expanded="true"] .dropdown-arrow {
          transform: rotate(180deg);
        }
      }

      .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: var(--weirdo-color-white);
        box-shadow: var(--weirdo-shadow-default);
        border-radius: 4px;
        padding: 0.5rem 0;
        min-width: 200px;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;

        &.open {
          opacity: 1;
          visibility: visible;
          transform: translateY(0);
        }

        a {
          display: block;
          padding: 0.75rem 1rem;
          color: var(--weirdo-color-text);
          text-decoration: none;
          transition: background-color 0.2s ease;

          &:hover {
            background-color: var(--weirdo-color-accent-2);
            color: var(--weirdo-color-white);
          }
        }

        .dropdown-divider {
          height: 1px;
          background: #e5e5e5;
          margin: 0.5rem 0;
        }
      }
    }

    .burger-wrapper {
      display: block;
      cursor: pointer;
      background: none;
      border: none;
      color: var(--weirdo-color-white);
      display: flex;
      align-items: center;
      z-index: 101;
      position: relative;

      @media (min-width: 1024px) {
        display: none;
      }

      .bar {
        position: relative;
        width: 50%;
        height: 2px;
        background: var(--weirdo-color-white);
        transition: transform 0.3s ease-in;
        z-index: 102;

        &::before, &::after {
          content: "";
          position: absolute;
          width: 100%;
          height: 100%;
          background: var(--weirdo-color-white);
          transition: transform 0.1s ease-in;
          left: 0;
        }

        &::before {
          top: -5px;
        }

        &::after {
          top: 5px;
        }

      }
      &.active {
        &::after {
          background-color: var(--weirdo-color-accent-3);
        }

        .bar {
          background-color: var(--weirdo-color-white);
          transform: rotate(45deg);

          &::before {
            transform: rotate(90deg);
            top: 0;
          }
  
          &::after {
            transform: rotate(90deg);
            top: 0;
          }
        }
      }
    }

    .icons-wrapper {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
  }

  .mobile-nav-wrapper {
    background: var(--weirdo-color-accent-3);
    padding: 1rem;
    display: flex;
    min-height: 500px;
    overflow-y: scroll;

    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100dvh;
    z-index: 100;
    transform: translateY(-100%);

    transition: transform 0.3s ease-in;

    &.open {
      transform: translateY(0);
    }

    @media (min-width: 1024px) {
      display: none;
    }

    .mobile-nav {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      align-items: center;
      justify-content: center;
      width: 100%;

      @media (max-height: 700px) {
        /* justify-content: flex-start;
        gap: 0.5rem; */
        
        a {
          font-size: var(--weirdo-text-xl); ;
        }
      }
    }

    a {
      color: var(--weirdo-color-white);
      font-size: var(--weirdo-text-2xl);
      margin: 0 1rem;
    }

    /* Mobile Dropdown Styles */
    .mobile-dropdown {
      .mobile-dropdown-trigger {
        width: 100%;
        background: none;
        border: none;
        font-family: inherit;
        font-size: var(--weirdo-text-2xl);
        color: var(--weirdo-color-white);
        padding: 0;
        margin: 0 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;

        @media (max-height: 700px) {
          font-size: var(--weirdo-text-xl);
        }

        .mobile-dropdown-arrow {
          font-size: 0.8em;
          transition: transform 0.2s ease;
        }

        &[aria-expanded="true"] .mobile-dropdown-arrow {
          transform: rotate(180deg);
        }
      }

      .mobile-dropdown-menu {
        margin-top: 0.5rem;
        padding-left: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease;
        
        @media (min-width: 1024px) {
          border-left: 2px solid var(--weirdo-color-accent-2);
        }

        &.open {
          max-height: 300px;
          padding: 0.5rem 0 0.5rem 1rem;
        }

        a {
          display: block;
          padding: 0.5rem 0;
          color: var(--weirdo-color-white);
          text-decoration: none;
          font-size: 0.9em;
          transition: color 0.2s ease;

          &:hover {
            color: var(--weirdo-color-accent-2);
          }
        }
      }
    }
  }
</style>